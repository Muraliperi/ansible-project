---
- name: Guided practice
  hosts: centosstream7, rockylinux9
  tasks:
     - name: Add a line to /tmp/testloop.yml file
      lineinfile:
        path: /tmp/testloop.yml
        line: 'This line added from Ansible playbook'
        state: present
        
     - name: Editing ssh config file and replacing PasswordAuthentication from "no" to "yes"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        state: present
        line: PasswordAuthentication yes
        validate: 'sshd -t -f %s'
        notify:
          - Restarting sshd

  handlers:
    - name: Restarting sshd
      service:
        name: sshd
        state: restarted
---
- name: Search a string in a file
  hosts: localhost
  vars:
    mypath: "/etc/ssh/sshd_config"
    mystring: "PasswordAuthentication no"

  tasks:
    - name: Find {{ mystring }} in ssh config file
      ansible.builtin.lineinfile:
        path: "{{ mypath }}"
        line: "{{ mystring }}"
        state: present
      check_mode: true
      register: conf
      failed_when: (conf is failed) or (conf is changed)
---
- name: Commenting a line in the file
  hosts: localhost
  vars:
    mypath: /etc/postfix/main.cf
    my_regex: '(^daemon_directory .*)'

  tasks:
    - name: Commentout a line
      ansible.builtin.lineinfile:
        path: "{{ mypath }}"
        regexp: "{{ my_regex }}"
        line: '# \1'
        backrefs: yes
        state: present
        backup: yes
